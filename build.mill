//| mill-version: 1.0.2
//| mvnDeps: ["io.github.mikybars::openapi-generator-mill-plugin::0.1.0"]
package build

import mill.*
import javalib.*
import checkstyle.*
import io.github.mikybars.mill.openapi.OpenApiModule
import mill.api.BuildCtx

object `package` extends JavaModule, CheckstyleModule, OpenApiModule {
  override def checkstyleVersion = "10.26.1"

  object openApi extends OpenApiConfig {
    def inputSpec: T[PathRef] = Task.Source(BuildCtx.workspaceRoot / "spec/openapi.yml")

    def apiPackage: T[String] = "com.github.mikybars.challenge.prices.adapters.in.rest"

    def modelPackage: T[String] = apiPackage()

    def generatorName: T[String] = "spring"

    def modelNameSuffix: T[String] = "Dto"

    def additionalProperties: T[Map[String, String]] = Map(
      "sourceFolder" -> "",
      "useSpringBoot3" -> "true",
      "interfaceOnly" -> "true",
      "skipDefaultInterface" -> "true",
      "dateLibrary" -> "java8-localdatetime",
      "openApiNullable" -> "false"
    )
  }

  override def generatedSources: T[Seq[PathRef]] = Seq(
    PathRef(Task.dest),
    openApi.generate()
  )

  override def mvnDeps: T[Seq[Dep]] = Seq(
    mvn"com.h2database:h2:2.2.224",
    mvn"jakarta.validation:jakarta.validation-api:3.0.2",
    mvn"io.github.wimdeblauwe:error-handling-spring-boot-starter:4.5.0",
    mvn"io.swagger.core.v3:swagger-core:2.2.28",
    mvn"org.springframework.boot:spring-boot-starter-data-jpa:3.4.4",
    mvn"org.springframework.boot:spring-boot-starter-web:3.4.4",
    mvn"org.springframework.boot:spring-boot-starter-webflux:3.4.4"
  )

  override def compileMvnDeps: T[Seq[Dep]] = Seq(
    mvn"org.projectlombok:lombok:1.18.36",
    mvn"org.mapstruct:mapstruct:1.5.3.Final",
    mvn"org.mapstruct:mapstruct-processor:1.5.3.Final"
  )

  override def javacOptions: T[Seq[String]] = Seq(
    "-Xlint:-options", "-parameters", "-Amapstruct.defaultComponentModel=spring",
    // see https://github.com/com-lihaoyi/mill/issues/5626
    "-s", generatedSources().head.path.toString()
  )

  trait MyTestModule extends JavaTests, TestModule.Junit5 {
    override def testSandboxWorkingDir = false

    override def testParallelism: T[Boolean] = true

    override def mvnDeps: T[Seq[Dep]] = Seq(
      mvn"org.springframework.boot:spring-boot-starter-test:3.4.4",
    )
  }

  object test extends MyTestModule {
    override def mvnDeps: T[Seq[Dep]] = super.mvnDeps() ++ Seq(
      mvn"com.tngtech.archunit:archunit-junit5:1.4.0",
    )

    override def runMvnDeps: T[Seq[Dep]] = super.mvnDeps() ++ Seq(
      mvn"com.google.code.gson:gson:2.12.1",
    )
  }

  object integration extends MyTestModule {
    override def moduleDeps: Seq[JavaModule] = Seq(test)

    override def mvnDeps: T[Seq[Dep]] = super.mvnDeps() ++ Seq(
      mvn"com.approvaltests:approvaltests:24.19.0",
    )
  }
}
